name: CD - Main Branch

on:
  push:
    branches: [main]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker image with tags
        run: |
          docker build -t jmaepraendith/472-s-golden-pillow-backend-6510451042:latest \
                 -t jmaepraendith/472-s-golden-pillow-backend-6510451042:${{ env.TAG }} .

    - name: Push Docker images
        run: |
          docker push jmaepraendith/472-s-golden-pillow-backend-6510451042:latest
          docker push jmaepraendith/472-s-golden-pillow-backend-6510451042:${{ env.TAG }}

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG }}
        name: Release ${{ env.TAG }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}




  deploy-main:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract version from commit SHA
        id: vars
        run: echo "VERSION=1.0.${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      - name: Build and push Docker image
        run: |
          docker build -t jmaepraendith/goldenpillow-backend:${{ env.VERSION }} .
          docker push jmaepraendith/goldenpillow-backend:${{ env.VERSION }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
